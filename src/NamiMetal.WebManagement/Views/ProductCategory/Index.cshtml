@{
    ViewBag.Title = "Quản lý danh mục sản phẩm";
}

@section Styles {
<style type="text/css">
</style>
}

<div class="page-heading">
    <div class="page-title">
        <div class="row">
            <div class="col-12 col-md-6 order-md-1 order-last">
                <h3>@Html.Raw(ViewBag.Title)</h3>

            </div>
            <div class="col-12 col-md-6 order-md-2 order-first">
                <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                    <ol class="breadcrumb">
                        @*<li class="breadcrumb-item"><a href="javascript:;">Dữ liệu cơ bản (v2)</a></li>*@
                        @*<li class="breadcrumb-item active" aria-current="page">Quản lý trường học (v2)</li>*@
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <section class="section">
        <div class="card border">
            <div class="card-header d-flex align-items-center">
                <h4 class="card-title m-0">Tìm kiếm</h4>
                <button class="btn ms-auto"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#search"
                        aria-expanded="true"
                        aria-controls="search">
                    <i class="fa fa-angle-down"></i>
                </button>
            </div>
            <div class="card-content show" id="search">
                <div class="card-body">
                    <form id="searchForm" class="form">
                        <div class="row">
                            <div class="col-md-3 col-12">
                                <div class="form-group">
                                    <label for="school-name-column">SO Code</label>
                                    <div class="position-relative">
                                        <input type="text" id="searchSOCode" class="form-control"
                                               placeholder="Nhập mã SO muốn tìm" name="school-name">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-12">
                                <div class="form-group">
                                    <label for="school-name-column">Mã số thuế</label>
                                    <div class="position-relative">
                                        <input type="text" id="searchSellerTaxCode" class="form-control"
                                               placeholder="Nhập mã số thuế muốn tìm" name="school-name">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-12">
                                <div class="form-group">
                                    <label for="school-name-column">Số hóa đơn</label>
                                    <div class="position-relative">
                                        <input type="text" id="searchInvoiceNo" class="form-control"
                                               placeholder="Nhập số hóa đơn muốn tìm" name="school-name">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-12">
                                <div class="form-group has-icon-left">
                                    <label for="school-name-column">Trạng thái</label>
                                    <div class="position-relative">
                                        <select class="form-select" id="searchStatus">
                                            <option value="" selected>--Chọn trạng thái--</option>
                                            <option value="RECEIVED_DATA_FROM_POS">Đã nhận dữ liệu từ POS</option>
                                            <option value="SENT_TO_TVAN">Đã gửi lên TVAN</option>
                                            <option value="TVAN_SEND_FAILED">Gửi lên TVAN không thành công</option>
                                            <option value="GDT_INVOICE_VALID">TCT thông báo hóa đơn hợp lệ</option>
                                            <option value="GDT_INVOICE_INVALID">TCT thông báo hóa đơn không hợp lệ</option>
                                            <option value="INV_RECEIVED_AND_WAITING_FOR_INVOICE">Đã nhận hóa đơn từ POS nhưng chưa có hóa đơn gốc</option>
                                            <option value="UNKNOWN">Không xác định</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-12">
                                <div class="form-group">
                                    <label for="school-name-column">Từ ngày (*)</label>
                                    <div class="position-relative">
                                        <input type="date" id="fromDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-12">
                                <div class="form-group">
                                    <label for="school-name-column">Đến ngày (*)</label>
                                    <div class="position-relative">
                                        <input type="date" id="toDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 d-flex justify-content-end">
                                <button type="submit"
                                        class="btn btn-primary me-1 mb-1">
                                    Tìm kiếm
                                </button>
                                @*<button type="reset"
                                    class="btn btn-light-secondary me-1 mb-1">
                                    Reset
                                    </button>*@
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Striped rows start -->
    <section class="section">
        <div class="card border">
            @*<div class="card-header d-flex align-items-center">
                <h4 class="card-title m-0">Danh sách hóa đơn</h4>
                </div>*@
            @*<div class="card-body"></div>*@
            <div id="dataTable" style="min-height: 100px;">
            </div>
        </div>
    </section>
    <!-- Striped rows end -->
</div>
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 90%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Chi tiết hoá đơn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            @*<div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                </div>*@
        </div>
    </div>
</div>

@section Scripts {
<script type="text/javascript">
    let $dataTable;
    let $searchForm;
    let $searchSOCode;
    let $searchSellerTaxCode;
    let $searchInvoiceNo;
    let $searchStatus;
    let $detailModal;
    let detailModalInstance;
    let PageIndex = 1;
    let PageSize = 10;
    let pagingAjaxInstance;
    let detailAjaxInstance;

    $(document).ready(function() {
        $dataTable = $("#dataTable");

        $searchForm = $("#searchForm");
        $detailModal = $("#detailModal");
        detailModalInstance = new bootstrap.Modal(document.getElementById('detailModal'), {
            backdrop: 'static',
            keyboard: false,
        });

        $detailModal.on("hide.bs.modal", function(e) {
            detailAjaxInstance && detailAjaxInstance.abort();
            detailAjaxInstance = null;
        });

        $(document).unbind().on("submit", "form", function(e) {
            e.preventDefault();

            getPaging({ index: 1 });
        });

        getPaging();
    });

    function getPaging({ index, size } = { index: PageIndex, size: PageSize }) {
        pagingAjaxInstance && pagingAjaxInstance.abort();
        pagingAjaxInstance = null;

        PageIndex = index || PageIndex;
        PageSize = size || PageSize;

        let payload = {
        };

        pagingAjaxInstance = $.ajax({
            url: `/Invoice/ReportGrid`,
            method: "GET",
            data: payload,
            beforeSend: () => {
                $dataTable.FLoading("show");
            },
            success: result => {
                $dataTable
                    .empty()
                    .append(result)
                    //.find(".choices")
                    //.each((i, e) => {
                    //    new Choices(e, {
                    //        itemSelectText: "Bấm để chọn",
                    //        loadingText: 'Đang tải...',
                    //        noResultsText: 'Không tìm thấy kết quả',
                    //        noChoicesText: 'Không có dữ liệu',
                    //    });
                    //})
                    ;
            }
        })
            .always(() => {
                $dataTable.FLoading("hide");
            });
    }


    function getInvoiceDetail({ SOCode, SellerTaxCode }) {
        detailModalInstance.show();

        detailAjaxInstance = $.ajax({
            url: `/Invoice/GetInvoiceDetails`,
            method: "GET",
            data: {
                SOCode,
                SellerTaxCode,
            },
            beforeSend: () => {
                //$detailModal.FLoading("show");
                $detailModal.find(".modal-body").empty().append("Đang tải dữ liệu...");
            },
            success: result => {
                $detailModal.find(".modal-body").empty().append(result);
            }
        })
            .always(() => {
                //$detailModal.FLoading("hide");
            });
    }
</script>
}